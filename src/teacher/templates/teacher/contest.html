{% extends "base.html" %}

{% block title %}
TKP Quiz | Cuộc thi
{% endblock title %}

{% block navigation %}
{% include 'teacher/navigation.html' with path='contest' %}
{% endblock navigation %}

{% block main %}
<div class="container mb-5 d-flex">
  <form class="flex-grow-1">
    <div class="input-group">
      <input type="text" class="form-control text-center" placeholder="Tìm kiếm tên cuộc thi"
        name="contest__name_filter" value="{{ contest__name_filter|default:'' }}" id="searchContestInput" autofocus>
      <button class="btn btn-primary" type="submit">
        <i class="fa-solid fa-magnifying-glass"></i>
      </button>
    </div>
  </form>

  <div class="ms-4">
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createContestModal"
      id="createContestShowModalBtn">Thêm mới
    </button>
  </div>
</div>

<div class="container py-4 rounded bg-body">
  {% if contests %}
  <h5 class="mb-4">Danh sách cuộc thi</h5>
  <table class="table table-hover">
    <thead>
      <tr class="align-middle">
        <th class="text-center">ID</th>
        <th>Tên cuộc thi</th>
        <th class="fit-content">Hệ số</th>
        <th class="text-center">Trình trạng</th>
        <th>Bắt đầu</th>
        <th>Kết thúc</th>
        <th class="fit-content">Số câu hỏi</th>
        <th class="fit-content">Câu hỏi</th>
        <th class="fit-content">Chỉnh sửa</th>
        <th class="fit-content">Xóa</th>
      </tr>
    </thead>
    <tbody class="load-fade">
      {% for contest in contests %}
      <tr class="align-middle">
        <td class="text-center">{{contest.id}}</td>
        <td>{{contest.name}}</td>
        <td class="fit-content">{{contest.coefficient}}</td>
        <td class="text-center">{{contest.get_status}}</td>
        <td>{{contest.start_time|date:"H:i d/m/Y"}}</td>
        <td>{{contest.end_time|date:"H:i d/m/Y"}}</td>
        <td class="fit-content">{{contest.get_num_questions}}</td>
        <td class="fit-content">
          <a class="btn btn-primary" href="{% url 'teacher_contest__question__list_create' contest__id=contest.id %}">
            <i class="fa-solid fa-question"></i>
          </a>
        </td>
        <td class="fit-content">
          <button type="button" class="btn btn-secondary"
            onclick="updateContestHandler(event, '/admin/contest/contest/{{contest.id}}/change/')">
            <i class="fa-solid fa-pen-to-square"></i>
          </button>
        </td>
        <td class="fit-content">
          <button type="button" class="btn btn-danger float-end delete-class-btn"
            onclick="deleteContestHanlder(event, `{% url 'teacher_contest__delete' contest__id=contest.id %}`, '{{contest.name}}')">
            <i class="fa-solid fa-trash"></i>
          </button>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
  <h6 class="text-center">Không có cuộc thi nào <i class="fa-solid fa-face-sad-tear"></i></h6>
  {% endif %}
</div>

<div class="modal fade modal-lg" id="createContestModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5">Thêm cuộc thi mới</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form class="needs-validation" method="POST" action="{% url 'teacher_contest__list_create' %}">
          <div class="input-group mb-3">
            <span class="input-group-text"">Tên cuộc thi</span>
            <input type=" text" class="form-control text-center" value="{{ form.name.value|default:'' }}" name="name"
              required>
          </div>
          <div class="input-group mb-3">
            <span class="input-group-text">Hệ số</span>
            <select class="form-select text-center" name="coefficient" required>
              <option value="1">Hệ số 1</option>
              <option value="2">Hệ số 2</option>
              <option value="3">Hệ số 3</option>
            </select>
          </div>
          <div class="input-group mb-3">
            <span class="input-group-text">Bắt đầu</span>
            <input type="datetime-local" class="form-control text-center" name="start_time"
              value="{{ form.start_time.value|default:'' }}" required>
          </div>
          <div class="input-group mb-3">
            <span class="input-group-text">Kết thúc</span>
            <input type="datetime-local" class="form-control text-center" name="end_time"
              value="{{ form.end_time.value|default:'' }}">
          </div>
          {% include 'form.html' %}
          <button type="submit" style="display: none;" id="createClassRoomSubmitBtn"></button>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
        <button type="button" class="btn btn-primary"
          onclick="document.getElementById('createClassRoomSubmitBtn').click()">Thêm cuộc thi</button>
      </div>
    </div>
  </div>
</div>

<button data-bs-toggle="modal" data-bs-target="#deleteContestModal" id="deleteContestShowModalBtn" hidden></button>
<form method="POST" id="deleteContestForm" hidden>{% csrf_token %}</form>
<div class="modal fade" id="deleteContestModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5">Xóa cuộc thi</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Bạn đang thực hiện lệnh xóa cuộc thi "<span class="fw-medium" id="deleteContestName"></span>"</p>
        <p>Sau khi thực hiện xong, bạn sẽ <mark>không thể khôi phục lại</mark> dữ liệu này nữa.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
        <button type="button" class="btn btn-danger" id="deleteContestSubmitBtn">Xóa cuộc thi</button>
      </div>
    </div>
  </div>
</div>
{% endblock main %}

{% block style %}
<style>
  #searchContestInput:focus {
    box-shadow: none;
  }

  .input-group-text {
    width: 115px;
  }
</style>
{% endblock style %}

{% block script %}
<script>
  // Update contest handler
  const updateContestHandler = (event, url) => {
    event.stopPropagation()
    openWindowAndReloadPage(url)
  }

  // Delete contest handler
  var deleteContestName = document.getElementById('deleteContestName')
  var deleteContestSubmitBtn = document.getElementById('deleteContestSubmitBtn')
  var deleteContestForm = document.getElementById('deleteContestForm')
  var deleteContestShowModalBtn = document.getElementById('deleteContestShowModalBtn')
  const deleteContestHanlder = (event, url, name) => {
    event.stopPropagation();
    deleteContestName.innerHTML = name
    deleteContestForm.action = url
    deleteContestSubmitBtn.addEventListener("click", () => { deleteContestForm.submit() })
    deleteContestShowModalBtn.click()
  }
</script>

{% if form.errors %}
<script>document.getElementById('createContestShowModalBtn').click()</script>
{% endif %}
{% endblock script %}
